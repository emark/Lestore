% layout 'default';
% title 'Редактор заказа';

<h1>Просмотр заказа</h1>
<p>Заказ номер: <%= $order->{id} %>-<%= $cartid %></p>
<form action="/orders/<%= $order->{cartid} %>/" method="post">

<table class="table table-hover">
  <thead>
    <tr>
      <th>Арт.</th>
      <th>Наименование</th>
      <th>Стоимость</th>
      <th>Количество</th>
      <th>Скидка</th>
    </tr>
  </thead>
  <tbody>
% my $totalorder = 0;
% my $discount_base = 0;
% my $total_cart = 0;
% my $discount_sum = 0;
% my $discount_cart = 0;
% foreach my $item (@{$items}){
	<tr>
	<td><input type="hidden" name=productid value="<%=$item->{productid} %>"><%=$item->{productid} %></td>
	<td><%=$item->{title} %></td>
	<td><%=$item->{price} %></td>
	<td><input class="input-mini" type="text" name="count" value="<%=$item->{count} %>"></td>
	<td><%= $item->{discount} %></td>
	</tr>
%	$discount_base = $discount_base+$item->{count}*$item->{price} if ($item->{discount} == 0);
%	$total_cart = $total_cart+($item->{count}*$item->{price});
% }
  </tbody>
</table>

% if(!$order->{writeoff}){
<a href="/orders/<%= $cartid %>/add" class="btn">Добавить товар</a>
% };

% $discount_sum = sprintf ("%d",$discount_base*$discount->{discount}/100);
% $discount_cart = $total_cart-$discount_sum;

<h3>Сумма заказа: <%= $discount_cart %> руб.</h3>
<p><b>Общая сумма заказа:</b> <%= $total_cart %> руб.<br />
<b>Дисконт / Промо-код:</b> <%= $order->{discount} %><br /><b>Скидка: </b><%= $discount->{discount} %>% 
% if(!$discount->{enable} && $order->{status} == 1){
<a href="/orders/<%= $cartid %>/discount/<%= $discount->{id} %>" class="btn btn-small">Пересчитать</a></p>
% }

<div class="row">
	<div class="span4">

<fieldset>
	<div class="control-group">
		<label class="control-label " for="person">Имя</label>
		<div class="controls">	
			<input class="span2" name="person" type="text" value="<%=$order->{person} %>" />
		</div>
	</div>
	<div class="control-group">
		<label class="control-label" for="tel"><strong>Телефон*</strong></label>
		<div class="controls">
			<input class="span2" name="tel" type="text" value="<%=$order->{tel} %>" />
			<span class="help-block">Как вводить номер: +73912920229</span>
		</div>
	</div>
	<div class="control-group">
		<label class="control-label " for="email">Почта</label>
		<div class="controls">
			<input name="email" class="span3" type="text" value="<%=$order->{email} %>" />
		</div>	
	</div>
</div>
	<div class="span4">

	<div class="control-group">
		<label class="control-label"><strong>Варианты доставки*</strong></label>

% my %delivery = ();
% $delivery{$order->{delivery}} = 'selected';

		<div class="controls">
			<select name="delivery">
				<option value="store" <%= $delivery{store} %>>Самовывоз</option>
				<option value="courier" <%= $delivery{courier} %>>Курьерская доставка</option>
				<option value="shipping" <%= $delivery{shipping} %>>Транспортная компания</option>
			</select>
	        </div>
		<label class="control-label ">Адрес доставки</label>
		<div class="controls">
			<textarea name="address" rows="2"><%=$order->{address} %></textarea>
		</div>
	</div>
	<div class="control-group">
	        <label class="control-label"><strong>Способ оплаты*</strong></label>

% my %payment = ();
% $payment{$order->{payment}} = 'selected';

        	<div class="controls">
			<select name="payment">
				<option value="cash" <%= $payment{cash} %>>Платёж наличными</option>
				<option value="yamoney" <%= $payment{yamoney} %>>Яндекс.Деньги</option>
				<option value="credit" <%= $payment{credit} %>>Оплата в кредит</option>
				<option value="check" <%= $payment{check} %>>Банковский перевод</option>
			</select>
	        </div>
	</div>
</div>
	<div class="span4">

% my %storename = ();
% $storename{$order->{storename}} = 'selected';

	<div class="controls">
	        <label class="control-label"><strong>Интернет-магазин</strong></label>
		<select name="storename">
			<option value="nastartshop" <%= $storename{nastartshop} %>>НаСтарт</option>
			<option value="papatut" <%= $storename{papatut} %>>Папатут</option>
		</select>
        </div>
	<div class="control-group">
        	<label class="control-label ">Комментарий к заказу</label>
		<div class="controls">
			<textarea name="comments" rows="3"><%=$order->{comments} %></textarea>
		</div>
	</div>

	
% if($order->{writeoff} == 0){
	<div class="control-group">
	        <label class="control-label"><strong>Статус заказа</strong></label>
% 	my %orderstatus = (0 => 'Входящие',1 => 'Активный',2 => 'Отменён',3 => 'Закрыт');
		<select name="orderstatus">
% 	foreach my $key (keys %orderstatus){
% 	my $selected = '';
% 	$selected = 'selected' if $key == $order->{status};
		  <option <%= $selected %> value="<%= $key %>"><%= $orderstatus{$key} %></option>
% 	}
		</select>
	</div>

	<div class="controls">
		<input type=submit class="btn btn-primary" value="Обновить заказ">
	</div>
% };

	</fieldset>
</div>
</div>
</form>

% if ($order->{status} == 3){

<div class="alert alert-error">
  <button type="button" class="close" data-dismiss="alert">&times;</button>
  <strong>Внимание!</strong> Опции ниже только для администратора.
</div>

<form action="/orders/<%= $cartid %>/writeoff/" method="post">
% foreach my $item (@{$items}){
<input type="hidden" name="productid" value="<%=$item->{productid} %>">
<input type="hidden" name="count" value="<%=$item->{count} %>">
% }

<label>Списание товаров</label>
% my @selected = ('','');
% $selected[$order->{writeoff}] = 'selected';
<select name="writeoff">
	<option value="0" <%= $selected[0] %>>Не проведено</option>
	<option value="1" <%= $selected[1] %>>Проведено</option>
</select>
<div class="controls">
%= submit_button 'Выполнить'
</div>
</form>
% };
